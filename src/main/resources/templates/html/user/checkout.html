<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Fajar Gold</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/js/cart-badge-utility.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold-primary: #d4af37;
            --gold-light: #f7e98e;
            --gold-dark: #b8860b;
            --gold-accent: #ffd700;
            --black-luxury: #0a0a0a;
            --black-soft: #1a1a1a;
            --white-pearl: #fff8dc;
            --white-pure: #ffffff;
            --gray-elegant: #4a5568;
            --gray-light: #f7fafc;
            --gray-medium: #e2e8f0;
            --gray-dark: #2d3748;
            --shadow-gold: 0 25px 50px rgba(212, 175, 55, 0.4);
            --shadow-luxury: 0 30px 60px rgba(0, 0, 0, 0.2);
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
            --gradient-gold: linear-gradient(135deg, #d4af37 0%, #ffd700 50%, #b8860b 100%);
            --gradient-gold-reverse: linear-gradient(135deg, #b8860b 0%, #ffd700 50%, #d4af37 100%);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }

        body {
            font-family: "Inter", sans-serif;
            background: var(--gray-light);
            color: var(--black-luxury);
            line-height: 1.6;
        }

        .header {
            background: var(--white-pure);
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar {
            padding: 20px 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 40px;
        }

        .logo {
            font-family: "Playfair Display", serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--gold-primary);
            text-decoration: none;
            letter-spacing: 2px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 40px;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--black-luxury);
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--gold-primary);
        }

        .nav-icons {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-icon {
            position: relative;
            color: var(--black-luxury);
            font-size: 22px;
            text-decoration: none;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 50%;
        }

        .nav-icon:hover {
            color: var(--gold-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        .cart-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--error-color);
            color: white;
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .checkout-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .page-title {
            font-family: "Playfair Display", serif;
            font-size: 42px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 50px;
            color: var(--black-luxury);
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gradient-gold);
            border-radius: 2px;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
        }

        .checkout-form {
            background: var(--white-pure);
            border-radius: 25px;
            padding: 35px;
            box-shadow: var(--shadow-soft);
        }

        .form-section {
            margin-bottom: 35px;
        }

        .section-title {
            font-family: "Playfair Display", serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--black-luxury);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: var(--black-luxury);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            padding: 15px;
            border: 2px solid var(--gray-medium);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .payment-method {
            border: 2px solid var(--gray-medium);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .payment-method:hover {
            border-color: var(--gold-primary);
            background: rgba(212, 175, 55, 0.05);
        }

        .payment-method.selected {
            border-color: var(--gold-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        .payment-method i {
            font-size: 32px;
            color: var(--gold-primary);
            margin-bottom: 10px;
        }

        .payment-method-name {
            font-weight: 600;
            color: var(--black-luxury);
            margin-bottom: 5px;
        }

        .payment-method-desc {
            font-size: 12px;
            color: var(--gray-elegant);
        }

        .order-summary {
            background: var(--white-pure);
            border-radius: 25px;
            padding: 35px;
            box-shadow: var(--shadow-soft);
            height: fit-content;
            position: sticky;
            top: 140px;
        }

        .summary-title {
            font-family: "Playfair Display", serif;
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--black-luxury);
        }

        .order-items {
            margin-bottom: 25px;
        }

        .order-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-medium);
            gap: 15px;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--black-luxury);
            margin-bottom: 5px;
        }

        .item-specs {
            font-size: 12px;
            color: var(--gray-elegant);
        }

        .item-price {
            font-weight: 700;
            color: var(--gold-primary);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-medium);
            font-size: 16px;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 20px;
            color: var(--gold-primary);
            padding-top: 20px;
            margin-top: 15px;
            border-top: 2px solid var(--gray-medium);
        }

        .pay-button {
            width: 100%;
            background: var(--gradient-gold);
            color: var(--black-luxury);
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .pay-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-gold);
        }

        .pay-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--gold-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 1024px) {
            .checkout-content {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .nav-menu {
                display: none;
            }
        }

        .payment-methods {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .payment-option {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .payment-option input[type="radio"] {
            margin-right: 10px;
        }

        .payment-option label {
            cursor: pointer;
            font-weight: 500;
        }

        .payment-instructions {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #28a745;
            border-radius: 8px;
            background-color: #f8fff9;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .payment-instructions h3 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .payment-instructions h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .upload-proof {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 6px;
            background-color: #f8f9fa;
        }

        .upload-proof h4 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .upload-proof input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .upload-proof button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .upload-proof button:hover {
            background: #0056b3;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .qr-container canvas {
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .qr-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .qr-info p {
            margin: 8px 0;
            font-size: 14px;
        }

        .qr-info strong {
            color: #28a745;
        }
    </style>
    <!-- QR Code Library dengan fallback yang lebih robust -->
    <script>
        // QR Code Library Manager
        class QRCodeManager {
            constructor() {
                this.isLoaded = false;
                this.loadAttempts = 0;
                this.maxAttempts = 3;
                this.cdns = [
                    'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
                    'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
                ];
            }

            async loadLibrary() {
                console.log('üöÄ Loading QR Code library...');
                
                // Check if already loaded
                if (typeof QRCode !== 'undefined') {
                    console.log('‚úÖ QR Code library already loaded');
                    this.isLoaded = true;
                    return true;
                }

                // Try each CDN
                for (let i = 0; i < this.cdns.length; i++) {
                    try {
                        console.log(`üì° Trying CDN ${i + 1}: ${this.cdns[i]}`);
                        await this.loadFromCDN(this.cdns[i]);
                        this.isLoaded = true;
                        console.log('‚úÖ QR Code library loaded successfully');
                        return true;
                    } catch (error) {
                        console.warn(`‚ùå CDN ${i + 1} failed:`, error.message);
                        continue;
                    }
                }

                // If all CDNs fail, create fallback
                console.log('‚ö†Ô∏è All CDNs failed, creating fallback QR code');
                this.createFallback();
                return false;
            }

            loadFromCDN(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Failed to load from ${url}`));
                    document.head.appendChild(script);
                });
            }

            createFallback() {
                console.log('üîß Creating QR code fallback...');
                window.QRCode = {
                    toCanvas: (canvas, text, options, callback) => {
                        try {
                            const ctx = canvas.getContext('2d');
                            const size = options?.width || 200;
                            
                            canvas.width = size;
                            canvas.height = size;
                            
                            // Clear canvas
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, size, size);
                            
                            // Draw border
                            ctx.strokeStyle = '#000000';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(0, 0, size, size);
                            
                            // Draw QR-like pattern
                            ctx.fillStyle = '#000000';
                            const blockSize = size / 25;
                            
                            // Corner patterns
                            this.drawCornerPattern(ctx, 0, 0, blockSize);
                            this.drawCornerPattern(ctx, size - blockSize * 7, 0, blockSize);
                            this.drawCornerPattern(ctx, 0, size - blockSize * 7, blockSize);
                            
                            // Center pattern
                            const centerX = size / 2 - blockSize * 2;
                            const centerY = size / 2 - blockSize * 2;
                            ctx.fillRect(centerX, centerY, blockSize * 4, blockSize * 4);
                            
                            // Add text
                            ctx.fillStyle = '#000000';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('QR Code', size/2, size/2 + 30);
                            ctx.fillText('Payment', size/2, size/2 + 45);
                            
                            if (callback) callback(null);
                        } catch (error) {
                            console.error('‚ùå Fallback QR generation error:', error);
                            if (callback) callback(error);
                        }
                    }
                };
                
                console.log('‚úÖ QR code fallback created');
            }

            drawCornerPattern(ctx, x, y, blockSize) {
                // Draw 7x7 corner pattern
                for (let i = 0; i < 7; i++) {
                    for (let j = 0; j < 7; j++) {
                        if ((i === 0 || i === 6 || j === 0 || j === 6) || 
                            (i >= 2 && i <= 4 && j >= 2 && j <= 4)) {
                            ctx.fillRect(x + i * blockSize, y + j * blockSize, blockSize, blockSize);
                        }
                    }
                }
            }

            generateQR(canvas, data, options = {}) {
                if (!this.isLoaded && typeof QRCode === 'undefined') {
                    console.error('‚ùå QR Code library not loaded');
                    return false;
                }

                return new Promise((resolve, reject) => {
                    try {
                        QRCode.toCanvas(canvas, data, {
                            width: options.width || 200,
                            height: options.height || 200,
                            margin: options.margin || 2,
                            color: {
                                dark: options.darkColor || '#000000',
                                light: options.lightColor || '#FFFFFF'
                            }
                        }, (error) => {
                            if (error) {
                                console.error('‚ùå QR generation error:', error);
                                reject(error);
                            } else {
                                console.log('‚úÖ QR code generated successfully');
                                resolve(true);
                            }
                        });
                    } catch (error) {
                        console.error('‚ùå QR generation exception:', error);
                        reject(error);
                    }
                });
            }
        }

        // Initialize QR Code Manager
        window.qrCodeManager = new QRCodeManager();
        
        // Load library when page loads
        window.addEventListener('load', async function() {
            try {
                await window.qrCodeManager.loadLibrary();
                console.log('‚úÖ QR Code system ready');
            } catch (error) {
                console.error('‚ùå Failed to initialize QR Code system:', error);
            }
        });
    </script>
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <a href="/user/home" class="logo">Fajar Gold</a>

                <ul class="nav-menu">
                    <li><a href="/user/home" class="nav-link">Beranda</a></li>
                    <li><a href="/user/katalog" class="nav-link">Katalog</a></li>
                    <li><a href="/user/my-orders" class="nav-link">Pesanan</a></li>
                    <li><a href="/user/about" class="nav-link">Tentang Kami</a></li>
                    <li><a href="/user/contact" class="nav-link">Kontak</a></li>
                </ul>

                <div class="nav-icons">
                    <a href="/user/wishlist" class="nav-icon" title="Wishlist">
                        <i class="fas fa-heart"></i>
                        <span class="cart-badge" id="wishlistBadge">0</span>
                    </a>
                    <a href="/user/cart" class="nav-icon" title="Keranjang">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-badge" id="cartBadge">0</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <div class="checkout-container">
        <h1 class="page-title">Checkout</h1>

        <div class="checkout-content">
            <div class="checkout-form">
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-user"></i>
                        Informasi Pribadi
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-input" id="fullName" placeholder="Masukkan nama lengkap"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="Masukkan email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-input" id="phone" placeholder="Masukkan nomor telepon"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Lahir</label>
                            <input type="date" class="form-input" id="birthDate" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Alamat Pengiriman
                    </h3>
                    <div class="form-group full-width">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-input form-textarea" id="address" placeholder="Masukkan alamat lengkap"
                            required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Kota</label>
                            <input type="text" class="form-input" id="city" placeholder="Masukkan kota" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kode Pos</label>
                            <input type="text" class="form-input" id="postalCode" placeholder="Masukkan kode pos"
                                required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-credit-card"></i>
                        Metode Pembayaran
                    </h3>
                    <div class="payment-methods">
                        <h3>Pilih Metode Pembayaran</h3>
                        
                        <div class="payment-option">
                            <input type="radio" id="qrCode" name="paymentMethod" value="QR_CODE" checked>
                            <label for="qrCode">
                                <i class="fas fa-qrcode"></i>
                                QR Code
                            </label>
                        </div>

                        <div class="payment-option">
                            <input type="radio" id="bankTransfer" name="paymentMethod" value="BANK_TRANSFER">
                            <label for="bankTransfer">
                                <i class="fas fa-university"></i>
                                Transfer Bank
                            </label>
                        </div>
                        
                        <!-- Test buttons untuk debug -->
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" onclick="checkoutManager.testQRCode()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üß™ Test QR Code
                            </button>
                            <button type="button" onclick="checkoutManager.debugCheckoutData()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üîç Debug Data
                            </button>
                            <button type="button" onclick="checkoutManager.loadSampleData()" style="padding: 8px 16px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;">
                                üì¶ Load Sample
                            </button>
                        </div>
                    </div>

                    <!-- Payment Instructions akan muncul di sini -->
                    <div id="paymentInstructions" class="payment-instructions" style="display: none;">
                        <h3>Instruksi Pembayaran</h3>
                        <div id="qrCodeSection" style="display: none;">
                            <h4>Scan QR Code</h4>
                            <div class="qr-container">
                                <canvas id="qrCodeImage"></canvas>
                            </div>
                            <p id="qrInstructions"></p>
                            <div class="qr-info">
                                <p><strong>Jumlah Pembayaran:</strong> <span id="qrAmount"></span></p>
                                <p><strong>Order ID:</strong> <span id="qrOrderId"></span></p>
                            </div>
                        </div>

                        <div id="bankTransferSection" style="display: none;">
                            <h4>Transfer Bank</h4>
                            <p><strong>Bank:</strong> <span id="bankName"></span></p>
                            <p><strong>Nomor Rekening:</strong> <span id="accountNumber"></span></p>
                            <p id="bankInstructions"></p>
                        </div>

                        <div class="upload-proof">
                            <h4>Upload Bukti Pembayaran</h4>
                            <input type="file" id="paymentProof" accept="image/*" required>
                            <button type="button" onclick="checkoutManager.uploadPaymentProof()"
                                class="btn btn-primary">
                                Upload Bukti Pembayaran
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="order-summary">
                <h3 class="summary-title">Ringkasan Pesanan</h3>

                <div class="order-items" id="orderItems">
                    <!-- Items will be populated by JavaScript -->
                </div>

                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal">Rp 0</span>
                </div>

                <div class="summary-row">
                    <span>Ongkos Kirim</span>
                    <span id="shippingCost">Rp 0</span>
                </div>

                <div class="summary-row">
                    <span>Diskon</span>
                    <span id="discount">-Rp 0</span>
                </div>

                <div class="summary-row">
                    <span>Total</span>
                    <span id="total">Rp 0</span>
                </div>

                <button class="pay-button" id="payButton" onclick="checkoutManager.processPayment()">
                    <i class="fas fa-lock"></i>
                    Bayar Sekarang
                </button>
            </div>
        </div>
    </div>

    <script>
        class CheckoutManager {
            constructor() {
                this.checkoutData = JSON.parse(localStorage.getItem('checkoutData')) || {};
                this.cart = JSON.parse(localStorage.getItem('cart')) || [];
                this.selectedPaymentMethod = (document.querySelector('input[name="paymentMethod"]:checked')?.value) || 'QR_CODE';
                this.isProcessing = false;
                this.currentPrices = {};
                this.priceChanges = [];
                this.priceHistory = [];
                this.currentOrderId = null;

                this.init();
            }

            init() {
                console.log('üöÄ Initializing CheckoutManager...');
                console.log('üì¶ Cart data:', this.cart);
                console.log('üõí Checkout data:', this.checkoutData);
                
                // Validasi data terlebih dahulu
                if (!this.validateCheckoutData()) {
                    console.error('‚ùå Checkout data validation failed, stopping initialization');
                    return;
                }
                
                this.renderOrderSummary();
                this.setupEventListeners();
                this.updateBadges();
                
                console.log('‚úÖ CheckoutManager initialized successfully');
            }

            validateCheckoutData() {
                console.log('üîç Validating checkout data:', this.checkoutData);

                // Cek apakah ada data checkout
                if (!this.checkoutData || Object.keys(this.checkoutData).length === 0) {
                    console.error('‚ùå Checkout data is empty or undefined');
                    this.showNotification('Data checkout tidak ditemukan. Silakan kembali ke keranjang.', 'error');
                    setTimeout(() => {
                        window.location.href = '/user/cart';
                    }, 2000);
                    return false;
                }

                // Cek apakah ada items
                if (!this.checkoutData.items || this.checkoutData.items.length === 0) {
                    console.error('‚ùå Checkout data validation failed: no items');
                    this.showNotification('Keranjang kosong. Silakan tambahkan produk terlebih dahulu.', 'error');
                    setTimeout(() => {
                        window.location.href = '/user/cart';
                    }, 2000);
                    return false;
                }

                // Store totalItems from checkout data for consistent badge updates
                this.totalItems = this.checkoutData.totalItems || this.checkoutData.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                
                // Validasi setiap item dengan lebih fleksibel
                const validItems = this.checkoutData.items.filter(item => {
                    // Cek apakah item memiliki minimal data yang diperlukan
                    const hasId = item.id || item.productId || item.product_id;
                    const hasName = item.name || item.productName || item.product_name;
                    const hasQuantity = item.quantity || item.qty || 1;
                    
                    if (!hasId) {
                        console.warn('‚ö†Ô∏è Item missing ID:', item);
                        // Jangan reject, coba generate ID
                        item.id = item.id || item.productId || item.product_id || Date.now();
                    }
                    
                    if (!hasName) {
                        console.warn('‚ö†Ô∏è Item missing name:', item);
                        // Jangan reject, gunakan default name
                        item.name = item.name || item.productName || item.product_name || 'Produk Tidak Diketahui';
                    }
                    
                    if (!hasQuantity || hasQuantity <= 0) {
                        console.warn('‚ö†Ô∏è Item has invalid quantity:', item);
                        // Jangan reject, set default quantity
                        item.quantity = item.quantity || item.qty || 1;
                    }
                    
                    // Normalize item properties
                    item.id = item.id || item.productId || item.product_id;
                    item.name = item.name || item.productName || item.product_name;
                    item.quantity = item.quantity || item.qty || 1;
                    item.price = item.price || item.finalPrice || item.harga || 0;
                    
                    console.log('‚úÖ Normalized item:', item);
                    return true; // Terima semua item, hanya normalize
                });
                
                if (validItems.length === 0) {
                    console.error('‚ùå No items found after normalization');
                    this.showNotification('Tidak ada item yang dapat diproses. Silakan periksa keranjang Anda.', 'error');
                    setTimeout(() => {
                        window.location.href = '/user/cart';
                    }, 2000);
                    return false;
                }
                
                // Update checkout data dengan items yang sudah dinormalisasi
                this.checkoutData.items = validItems;
                console.log('‚úÖ Checkout data validation passed with', validItems.length, 'items');
                return true;
            }

            setupEventListeners() {
                // Gunakan radio input pada .payment-option
                const radios = document.querySelectorAll('.payment-option input[name="paymentMethod"]');
                radios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.selectedPaymentMethod = radio.value;
                        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                        radio.closest('.payment-option')?.classList.add('selected');
                    });
                });

                // Auto-select state untuk yang sudah checked
                const firstChecked = document.querySelector('input[name="paymentMethod"]:checked');
                if (firstChecked) {
                    this.selectedPaymentMethod = firstChecked.value;
                    firstChecked.closest('.payment-option')?.classList.add('selected');
                }

                // Update form submission
                const updateForm = document.getElementById('updateForm');
                if (updateForm) {
                    updateForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const harga24k = document.getElementById('harga24k').value;
                        if (!harga24k) {
                            this.showNotification('Masukkan harga 24K', 'error');
                            return;
                        }

                        const success = await this.updatePrice({
                            harga24k: parseInt(harga24k),
                            source: 'MANUAL'
                        });

                        if (success) {
                            closeUpdateModal();
                        }
                    });
                }
            }
            renderOrderSummary() {
                console.log('üìã Rendering order summary...');
                const orderItems = document.getElementById('orderItems');
                const items = this.checkoutData.items || [];

                console.log('üõçÔ∏è Items to render:', items);

                if (!orderItems) {
                    console.error('‚ùå Order items container not found');
                    return;
                }

                if (items.length === 0) {
                    orderItems.innerHTML = `
                        <div class="order-item">
                            <div class="item-details">
                                <div class="item-name">Tidak ada item</div>
                                <div class="item-specs">Silakan kembali ke keranjang</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                orderItems.innerHTML = items.map((item, index) => {
                    console.log(`üì¶ Rendering item ${index + 1}:`, item);
                    
                    // Normalize item data untuk display
                    const itemName = item.name || item.productName || item.product_name || 'Produk Tidak Diketahui';
                    const itemQuantity = item.quantity || item.qty || 1;
                    const itemPrice = item.price || item.finalPrice || item.harga || item.totalPrice || 0;
                    const itemImage = item.image || item.imageUrl || item.img || '/placeholder.svg';
                    
                    // Build specs string dengan berbagai kemungkinan field
                    let itemSpecs = '';
                    if (item.specs) {
                        itemSpecs = item.specs;
                    } else if (item.weight || item.purity) {
                        itemSpecs = `Berat: ${item.weight || 'N/A'} gram | Kadar: ${item.purity || 'N/A'}K`;
                    } else if (item.description) {
                        itemSpecs = item.description;
                    } else {
                        itemSpecs = `Qty: ${itemQuantity}`;
                    }
                    
                    return `
                        <div class="order-item">
                            <div class="item-image">
                                <img src="${itemImage}" 
                                     alt="${itemName}"
                                     onerror="this.src='/placeholder.svg'">
                            </div>
                            <div class="item-details">
                                <div class="item-name">${itemName}</div>
                                <div class="item-specs">Qty: ${itemQuantity} | ${itemSpecs}</div>
                            </div>
                            <div class="item-price">${this.formatCurrency(itemPrice)}</div>
                        </div>
                    `;
                }).join('');

                // Update summary
                this.updateSummary();
                console.log('‚úÖ Order summary rendered successfully');
            }

            updateSummary() {
                console.log('üí∞ Updating summary...');
                const items = this.checkoutData.items || [];
                
                console.log('üõçÔ∏è Items for summary calculation:', items);
                
                const subtotal = items.reduce((sum, item) => {
                    const price = item.price || item.finalPrice || item.harga || item.totalPrice || 0;
                    const quantity = item.quantity || item.qty || 1;
                    const itemTotal = price * quantity;
                    const itemName = item.name || item.productName || item.product_name || 'Unknown';
                    console.log(`üì¶ Item: ${itemName}, Price: ${price}, Qty: ${quantity}, Total: ${itemTotal}`);
                    return sum + itemTotal;
                }, 0);

                const shipping = this.checkoutData.shipping || 0;
                const discount = this.checkoutData.discount || 0;
                const discountAmount = subtotal * discount;
                const total = subtotal + shipping - discountAmount;

                console.log('üí∞ Summary calculation:', {
                    subtotal,
                    shipping,
                    discount,
                    discountAmount,
                    total
                });

                // Update DOM elements with error handling
                const subtotalEl = document.getElementById('subtotal');
                const shippingEl = document.getElementById('shippingCost');
                const discountEl = document.getElementById('discount');
                const totalEl = document.getElementById('total');

                if (subtotalEl) subtotalEl.textContent = this.formatCurrency(subtotal);
                if (shippingEl) shippingEl.textContent = shipping === 0 ? 'GRATIS' : this.formatCurrency(shipping);
                if (discountEl) discountEl.textContent = discountAmount > 0 ? `-${this.formatCurrency(discountAmount)}` : 'Rp 0';
                if (totalEl) totalEl.textContent = this.formatCurrency(total);

                console.log('‚úÖ Summary updated successfully');
            }

            async processPayment() {
                console.log('üí≥ Starting payment process...');
                
                if (this.isProcessing) {
                    console.log('‚è≥ Payment already processing, ignoring request');
                    return;
                }

                // Validate form
                if (!this.validateForm()) {
                    console.log('‚ùå Form validation failed');
                    return;
                }

                // Validate checkout data again
                if (!this.validateCheckoutData()) {
                    console.log('‚ùå Checkout data validation failed');
                    return;
                }

                this.isProcessing = true;
                this.updatePayButton(true);

                try {
                    // Prepare checkout data with better error handling
                    const items = this.checkoutData.items || [];
                    console.log('üõçÔ∏è Preparing checkout request with items:', items);
                    
                    const checkoutRequest = {
                        items: items.map(item => {
                            // Prioritize productId over id (cart item id)
                            const itemId = item.productId || item.id || item.product_id;
                            const itemName = item.name || item.productName || item.product_name || 'Unknown';

                            if (!itemId) {
                                console.error('‚ùå Item missing ID:', item);
                                throw new Error(`Item "${itemName}" tidak memiliki ID yang valid`);
                            }

                            console.log('üì¶ Mapping item for checkout:', {
                                itemName,
                                cartItemId: item.id,
                                productId: item.productId,
                                finalId: itemId
                            });

                            return {
                                productId: itemId,
                                quantity: item.quantity || item.qty || 1
                            };
                        }),
                        customerInfo: {
                            fullName: document.getElementById('fullName')?.value || '',
                            email: document.getElementById('email')?.value || '',
                            phone: document.getElementById('phone')?.value || '',
                            birthDate: document.getElementById('birthDate')?.value || '',
                            address: document.getElementById('address')?.value || '',
                            city: document.getElementById('city')?.value || '',
                            postalCode: document.getElementById('postalCode')?.value || ''
                        },
                        paymentMethod: this.selectedPaymentMethod,
                        totalAmount: this.calculateTotal()
                    };

                    // Validate customer info
                    const customerInfo = checkoutRequest.customerInfo;
                    const requiredFields = ['fullName', 'email', 'phone', 'birthDate', 'address', 'city', 'postalCode'];
                    const missingFields = requiredFields.filter(field => !customerInfo[field]);
                    
                    if (missingFields.length > 0) {
                        throw new Error(`Field berikut harus diisi: ${missingFields.join(', ')}`);
                    }

                    console.log('üì§ Sending checkout request:', JSON.stringify(checkoutRequest, null, 2));

                    // Send to backend
                    const response = await fetch('/user/checkout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(checkoutRequest)
                    });

                    console.log('üì• Response status:', response.status);
                    const result = await response.json();
                    console.log('üì• Response data:', result);

                    if (!response.ok) {
                        console.error('‚ùå Error response details:', {
                            status: response.status,
                            statusText: response.statusText,
                            result: result
                        });

                        const errorMessage = result.message || result.error || 'Gagal memproses checkout';
                        throw new Error(errorMessage);
                    }

                    if (result.success) {
                        console.log('‚úÖ Checkout successful');
                        this.showNotification('Pesanan berhasil dibuat!', 'success');

                        // Handle payment instruction
                        if (result.data && result.data.externalId) {
                            console.log('üìä Payment data received:', result.data);
                            this.showPaymentInstructions(result.data);
                            this.currentOrderId = result.data.externalId;
                        } else {
                            console.warn('‚ö†Ô∏è No payment data received');
                            this.showNotification('Pesanan berhasil dibuat, tetapi data pembayaran tidak lengkap', 'warning');
                        }

                        // Clear cart from localStorage and database
                        await this.clearCartAfterPayment();

                    } else {
                        throw new Error(result.message || 'Gagal memproses checkout');
                    }

                } catch (error) {
                    console.error('‚ùå Checkout error:', error);
                    this.showNotification('Gagal memproses checkout: ' + error.message, 'error');
                } finally {
                    this.isProcessing = false;
                    this.updatePayButton(false);
                }
            }

            validateForm() {
                const requiredFields = ['fullName', 'email', 'phone', 'birthDate', 'address', 'city', 'postalCode'];
                let isValid = true;

                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        console.error(`Field ${fieldId} is empty`);
                        isValid = false;
                    }
                });

                if (!isValid) {
                    this.showNotification('Mohon lengkapi semua field yang diperlukan', 'error');
                }

                return isValid;
            }

            calculateTotal() {
                const items = this.checkoutData.items || [];
                const subtotal = items.reduce((sum, item) => {
                    const price = item.price || item.finalPrice || item.harga || item.totalPrice || 0;
                    const quantity = item.quantity || item.qty || 1;
                    return sum + (price * quantity);
                }, 0);

                const shipping = this.checkoutData.shipping || this.checkoutData.ongkir || 0;
                const discount = this.checkoutData.discount || this.checkoutData.diskon || 0;
                const discountAmount = subtotal * discount;

                return subtotal + shipping - discountAmount;
            }

            updatePayButton(loading) {
                const button = document.getElementById('payButton');
                if (loading) {
                    button.innerHTML = '<div class="loading"></div> Memproses...';
                    button.disabled = true;
                } else {
                    button.innerHTML = '<i class="fas fa-lock"></i> Bayar Sekarang';
                    button.disabled = false;
                }
            }

            async showPaymentInstructions(paymentData) {
                console.log('üéØ === SHOWING PAYMENT INSTRUCTIONS ===');
                console.log('üìä Payment data:', paymentData);
                
                const instructionsDiv = document.getElementById('paymentInstructions');
                const qrSection = document.getElementById('qrCodeSection');
                const bankSection = document.getElementById('bankTransferSection');

                if (!instructionsDiv || !qrSection || !bankSection) {
                    console.error('‚ùå Required elements not found:', {
                        instructionsDiv: !!instructionsDiv,
                        qrSection: !!qrSection,
                        bankSection: !!bankSection
                    });
                    return;
                }

                // Reset semua section
                qrSection.style.display = 'none';
                bankSection.style.display = 'none';

                if (paymentData.paymentMethod === 'QR_CODE') {
                    console.log('üì± Showing QR Code section');
                    qrSection.style.display = 'block';
                    bankSection.style.display = 'none';

                    // Set order info
                    const qrAmount = document.getElementById('qrAmount');
                    const qrOrderId = document.getElementById('qrOrderId');
                    
                    if (qrAmount && paymentData.amount) {
                        qrAmount.textContent = this.formatCurrency(paymentData.amount);
                        console.log('üí∞ Set QR amount:', paymentData.amount);
                    }
                    if (qrOrderId && paymentData.externalId) {
                        qrOrderId.textContent = paymentData.externalId;
                        console.log('üí∞ Set QR order ID:', paymentData.externalId);
                    }

                    // Generate QR code
                    console.log('üöÄ Starting QR code generation...');
                    try {
                        if (paymentData.qrData) {
                            console.log('üì° Using qrData from backend');
                            await this.generateQRCode(paymentData.qrData);
                        } else {
                            console.log('üîÑ Using fallback QR generation');
                            await this.generateSimpleQRCode(paymentData.amount || 0);
                        }
                    } catch (error) {
                        console.error('‚ùå QR code generation failed:', error);
                        this.showNotification('Gagal generate QR code, menggunakan placeholder', 'warning');
                    }

                    // Set instructions
                    const qrInstructions = document.getElementById('qrInstructions');
                    if (qrInstructions && paymentData.instructions) {
                        qrInstructions.textContent = paymentData.instructions;
                        console.log('üìù Set QR instructions:', paymentData.instructions);
                    }

                } else if (paymentData.paymentMethod === 'BANK_TRANSFER') {
                    console.log('üè¶ Showing Bank Transfer section');
                    qrSection.style.display = 'none';
                    bankSection.style.display = 'block';

                    // Set bank details
                    const bankName = document.getElementById('bankName');
                    const accountNumber = document.getElementById('accountNumber');
                    const bankInstructions = document.getElementById('bankInstructions');

                    if (bankName && paymentData.bankName) {
                        bankName.textContent = paymentData.bankName;
                    }
                    if (accountNumber && paymentData.bankAccountNumber) {
                        accountNumber.textContent = paymentData.bankAccountNumber;
                    }
                    if (bankInstructions && paymentData.instructions) {
                        bankInstructions.textContent = paymentData.instructions;
                    }
                }

                // Tampilkan section instruksi pembayaran
                instructionsDiv.style.display = 'block';
                console.log('‚úÖ Payment instructions section displayed');
                
                // Scroll ke instruksi pembayaran
                instructionsDiv.scrollIntoView({ behavior: 'smooth' });
                
                // Tampilkan notifikasi sukses
                this.showNotification('Instruksi pembayaran berhasil ditampilkan!', 'success');
            }

            // Method untuk generate QR code yang sebenarnya
            async generateQRCode(qrData) {
                console.log('üöÄ Generating QR code with data:', qrData);
                const qrContainer = document.getElementById('qrCodeImage');
                if (!qrContainer) {
                    console.error('‚ùå QR container not found');
                    return;
                }

                // Clear container
                qrContainer.innerHTML = '';

                try {
                    // Use QR Code Manager
                    if (window.qrCodeManager) {
                        console.log('üì± Using QR Code Manager...');
                        const success = await window.qrCodeManager.generateQR(qrContainer, qrData, {
                            width: 200,
                            height: 200,
                            margin: 2,
                            darkColor: '#000000',
                            lightColor: '#FFFFFF'
                        });
                        
                        if (success) {
                            console.log('‚úÖ QR code generated successfully with QR Code Manager');
                        } else {
                            throw new Error('QR Code Manager failed to generate QR code');
                        }
                    } else {
                        // Fallback to direct QRCode library
                        console.log('üì± Using direct QRCode library...');
                        if (typeof QRCode === 'undefined') {
                            throw new Error('QRCode library not available');
                        }
                        
                        await new Promise((resolve, reject) => {
                            QRCode.toCanvas(qrContainer, qrData, {
                                width: 200,
                                height: 200,
                                margin: 2,
                                color: {
                                    dark: '#000000',
                                    light: '#FFFFFF'
                                }
                            }, (error) => {
                                if (error) {
                                    console.error('‚ùå Error generating QR code:', error);
                                    reject(error);
                                } else {
                                    console.log('‚úÖ QR code generated successfully with direct library');
                                    resolve();
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('‚ùå QR code generation failed:', error);
                    this.showQRPlaceholder(qrContainer);
                }
            }

            // Method fallback untuk generate QR code sederhana
            async generateSimpleQRCode(amount) {
                console.log('üöÄ Generating simple QR code for amount:', amount);
                const qrContainer = document.getElementById('qrCodeImage');
                if (!qrContainer) return;

                // Clear container
                qrContainer.innerHTML = '';

                // Generate QR code sederhana dengan data pembayaran
                const paymentData = `FAJAR_GOLD_PAYMENT_${amount}_${Date.now()}`;
                console.log('üì± Payment data for QR:', paymentData);
                
                try {
                    // Use QR Code Manager
                    if (window.qrCodeManager) {
                        console.log('üì± Using QR Code Manager for simple QR...');
                        const success = await window.qrCodeManager.generateQR(qrContainer, paymentData, {
                            width: 200,
                            height: 200,
                            margin: 2,
                            darkColor: '#000000',
                            lightColor: '#FFFFFF'
                        });
                        
                        if (success) {
                            console.log('‚úÖ Simple QR code generated successfully with QR Code Manager');
                        } else {
                            throw new Error('QR Code Manager failed to generate simple QR code');
                        }
                    } else {
                        // Fallback to direct QRCode library
                        console.log('üì± Using direct QRCode library for simple QR...');
                        if (typeof QRCode === 'undefined') {
                            throw new Error('QRCode library not available');
                        }
                        
                        await new Promise((resolve, reject) => {
                            QRCode.toCanvas(qrContainer, paymentData, {
                                width: 200,
                                height: 200,
                                margin: 2,
                                color: {
                                    dark: '#000000',
                                    light: '#FFFFFF'
                                }
                            }, (error) => {
                                if (error) {
                                    console.error('‚ùå Error generating simple QR code:', error);
                                    reject(error);
                                } else {
                                    console.log('‚úÖ Simple QR code generated successfully with direct library');
                                    resolve();
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Simple QR code generation failed:', error);
                    this.showQRPlaceholder(qrContainer);
                }
            }

            // Method untuk menampilkan placeholder QR code
            showQRPlaceholder(container) {
                console.log('üñºÔ∏è Showing QR placeholder');
                container.innerHTML = `
                    <div style="width:200px;height:200px;background:#f8f9fa;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed #28a745;border-radius:8px;margin:0 auto;">
                        <i class="fas fa-qrcode" style="font-size:48px;color:#28a745;margin-bottom:10px;"></i>
                        <p style="color:#28a745;font-size:12px;text-align:center;margin:0;font-weight:bold;">QR Code Pembayaran</p>
                        <p style="color:#6c757d;font-size:10px;text-align:center;margin:5px 0 0 0;">Scan dengan aplikasi<br>e-wallet Anda</p>
                        <div style="margin-top:10px;padding:5px 10px;background:#e8f5e8;border-radius:4px;border:1px solid #28a745;">
                            <p style="color:#155724;font-size:9px;margin:0;text-align:center;">QR Code akan muncul<br>setelah library ter-load</p>
                        </div>
                    </div>
                `;
            }

            async clearCartAfterPayment() {
                try {
                    console.log('üóëÔ∏è Clearing cart after successful payment proof upload...');

                    // 1. Clear from localStorage first
                    localStorage.removeItem('cart');
                    localStorage.removeItem('checkoutData');
                    localStorage.removeItem('cartChanged'); // Clear change flag
                    console.log('‚úÖ Cart cleared from localStorage');

                    // 2. Update local cart data
                    this.cart = [];
                    this.checkoutData = {};

                    // 3. Force refresh cart from database to ensure it's empty
                    try {
                        const userId = await this.getCurrentUserId();
                        if (userId) {
                            console.log('üîÑ Force refreshing cart from database for user:', userId);
                            const response = await fetch(`/user/api/cart?userId=${userId}`);
                            if (response.ok) {
                                const result = await response.json();
                                console.log('üì• Current cart from database after checkout:', result);
                                if (result.success && result.data && result.data.items && result.data.items.length > 0) {
                                    console.log('‚ö†Ô∏è Cart not empty in database, items still present:', result.data.items.length);
                                } else {
                                    console.log('‚úÖ Cart confirmed empty in database');
                                }
                            }
                        }
                    } catch (dbError) {
                        console.warn('‚ö†Ô∏è Could not verify database cart status:', dbError);
                    }

                    // 4. Update badges immediately
                    this.updateBadges();

                    // 5. Trigger global cart refresh for all other pages/tabs
                    if (window.CartBadgeManager) {
                        console.log('üîÑ Triggering global cart refresh...');
                        await CartBadgeManager.forceRefresh();
                        CartBadgeManager.triggerCartUpdate({ action: 'cleared_after_checkout' });
                    }

                    // 6. Set storage flag to notify other tabs
                    localStorage.setItem('cartCleared', Date.now().toString());

                    console.log('‚úÖ Cart clearing completed successfully');
                    this.showNotification('Keranjang berhasil dikosongkan setelah pembayaran!', 'success');

                } catch (error) {
                    console.error('‚ùå Error clearing cart:', error);
                    this.showNotification('Ada masalah saat mengosongkan keranjang, silakan refresh halaman', 'warning');
                }
            }

            async uploadPaymentProof() {
                console.log('üì§ Starting payment proof upload...');

                const fileInput = document.getElementById('paymentProof');
                const file = fileInput.files[0];

                if (!file) {
                    this.showNotification('Pilih file bukti pembayaran terlebih dahulu', 'error');
                    return;
                }

                if (!this.currentOrderId) {
                    this.showNotification('Order ID tidak ditemukan', 'error');
                    return;
                }

                console.log('üìÑ File selected:', file.name, 'Size:', file.size);
                console.log('üÜî Order ID:', this.currentOrderId);

                const formData = new FormData();
                formData.append('paymentProof', file);
                formData.append('orderId', this.currentOrderId);

                try {
                    console.log('üöÄ Sending upload request...');
                    const response = await fetch('/user/upload-payment-proof', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('üì• Upload response status:', response.status);

                    if (response.ok) {
                        console.log('‚úÖ Payment proof uploaded successfully');
                        this.showNotification('Bukti pembayaran berhasil diupload. Menunggu konfirmasi admin.', 'success');

                        // Clear cart after successful payment proof upload
                        console.log('üóëÔ∏è Clearing cart after payment proof upload...');
                        await this.clearCartAfterPayment();

                        // Tampilkan popup konfirmasi
                        setTimeout(() => {
                            if (confirm('Bukti pembayaran berhasil diupload. Pembayaran akan dikonfirmasi oleh admin dalam 1-2 jam kerja. Klik OK untuk kembali ke beranda.')) {
                                window.location.href = '/user/home';
                            }
                        }, 1000);

                    } else {
                        const errorResult = await response.json();
                        console.error('‚ùå Upload failed:', errorResult);
                        throw new Error(errorResult.message || 'Gagal upload bukti pembayaran');
                    }
                } catch (error) {
                    console.error('‚ùå Error uploading proof:', error);
                    this.showNotification('Gagal upload bukti pembayaran: ' + error.message, 'error');
                }
            }

            updateBadges() {
                console.log('CheckoutManager: Updating badges after cart clear...');

                // Use CartBadgeManager for consistent badge updates
                if (window.cartBadgeManager) {
                    console.log('CheckoutManager: Using CartBadgeManager for badge updates');
                    window.cartBadgeManager.refreshCart();
                } else {
                    // Fallback to local method - count unique products instead of total quantity
                    console.log('CheckoutManager: Using local fallback for badge updates');
                    const cartBadge = document.getElementById('cartBadge');
                    const wishlistBadge = document.getElementById('wishlistBadge');

                    if (cartBadge) {
                        // After clearing, cart should be empty
                        const uniqueProducts = 0;
                        cartBadge.textContent = uniqueProducts;

                        // Hide badge when empty
                        cartBadge.style.display = 'none';

                        console.log('CheckoutManager: Cart cleared, badge set to 0 and hidden');
                    }

                    if (wishlistBadge) {
                        wishlistBadge.textContent = '0';
                    }
                }

                console.log('CheckoutManager: Badge update completed');
            }

            async fetchExternalPrice() {
                try {
                    console.log('üåê Fetching external price...');
                    const response = await fetch('/api/external');
                    const data = await response.json();
                    
                    if (data.success) {
                        const success = await this.updatePrice({
                            harga24k: data.data.harga24k,
                            source: 'EXTERNAL_API'
                        });
                        
                        if (success) {
                            this.showNotification('Harga eksternal berhasil diambil!', 'success');
                        }
                    } else {
                        this.showNotification('Error fetching external price', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching external price:', error);
                    this.showNotification('Error fetching external price', 'error');
                }
            }

            async refreshData() {
                await this.loadCurrentPrices();
                await this.loadPriceChanges();
                await this.loadPriceHistory();
                this.showNotification('Data berhasil di-refresh!', 'success');
            }

            async loadCurrentPrices() {
                try {
                    const response = await fetch('/api/prices');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentPrices = data.data;
                        this.updatePriceDisplay();
                    }
                } catch (error) {
                    console.error('Error loading current prices:', error);
                    this.showNotification('Error loading prices', 'error');
                }
            }

            async loadPriceChanges() {
                try {
                    const response = await fetch('/api/changes');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.priceChanges = data.data;
                        this.updateChangesDisplay();
                    }
                } catch (error) {
                    console.error('Error loading price changes:', error);
                }
            }

            async loadPriceHistory() {
                try {
                    const response = await fetch('/api/history');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.priceHistory = data.data.content;
                        this.updateHistoryDisplay();
                    }
                } catch (error) {
                    console.error('Error loading price history:', error);
                }
            }

            updatePriceDisplay() {
                const formatPrice = (price) => {
                    return new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0
                    }).format(price);
                };

                document.getElementById('price-24k').textContent = formatPrice(this.currentPrices['24k']);
                document.getElementById('price-22k').textContent = formatPrice(this.currentPrices['22k']);
                document.getElementById('price-18k').textContent = formatPrice(this.currentPrices['18k']);
            }

            updateChangesDisplay() {
                const container = document.getElementById('changes-container');
                
                if (this.priceChanges.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-info-circle text-2xl mb-2"></i>
                            <p>Belum ada perubahan harga</p>
                        </div>
                    `;
                    return;
                }

                const changesHTML = this.priceChanges.map(change => {
                    const changeIcon = change.changeType === 'INCREASE' ? 'fa-arrow-up' : 'fa-arrow-down';
                    const changeClass = change.changeType === 'INCREASE' ? 'change-positive' : 'change-negative';
                    const changeText = change.changeType === 'INCREASE' ? 'Naik' : 'Turun';
                    
                    return `
                        <div class="border-l-4 border-blue-500 pl-4 py-3 bg-gray-50 rounded-r-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${change.purity} - ${changeText}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(change.oldPrice)} 
                                        <i class="fas fa-arrow-right mx-2 text-gray-400"></i>
                                        ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(change.newPrice)}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ${new Date(change.changeDate).toLocaleString('id-ID')} ‚Ä¢ ${change.changeSource}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold ${changeClass}">
                                        <i class="fas ${changeIcon} mr-1"></i>
                                        ${change.changePercent}%
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(Math.abs(change.changeAmount))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = changesHTML;
            }

            updateHistoryDisplay() {
                const container = document.getElementById('history-container');
                
                if (this.priceHistory.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-info-circle text-2xl mb-2"></i>
                            <p>Belum ada riwayat harga</p>
                        </div>
                    `;
                    return;
                }

                const historyHTML = this.priceHistory.map(item => {
                    return `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-800">
                                    ${new Date(item.tanggalAmbil).toLocaleDateString('id-ID', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </h4>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                    ${item.goldPriceEnum || 'MANUAL'}
                                </span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="font-semibold text-gray-800">24K</div>
                                    <div class="text-gray-600">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.hargaJual24k)}</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-800">22K</div>
                                    <div class="text-gray-600">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.hargaJual22k)}</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-gray-800">18K</div>
                                    <div class="text-gray-600">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.hargaJual18k)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = historyHTML;
            }

            async updatePrice(priceData) {
                try {
                    const response = await fetch('/api/prices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(priceData)
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentPrices = data.data;
                        this.updatePriceDisplay();
                        await this.loadPriceChanges();
                        await this.loadPriceHistory();
                        this.showNotification('Harga berhasil diupdate!', 'success');
                        return true;
                    } else {
                        this.showNotification(data.message || 'Error updating price', 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('Error updating price:', error);
                    this.showNotification('Error updating price', 'error');
                    return false;
                }
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-weight: 500;
                    max-width: 300px;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Method untuk test QR code
            async testQRCode() {
                console.log('üß™ Testing QR code generation...');
                const testContainer = document.getElementById('qrCodeImage');
                if (!testContainer) {
                    console.error('‚ùå Test container not found');
                    return;
                }

                // Clear container first
                testContainer.innerHTML = '';

                try {
                    // Use QR Code Manager
                    if (window.qrCodeManager) {
                        console.log('üì± Using QR Code Manager for test...');
                        const success = await window.qrCodeManager.generateQR(testContainer, 'TEST_QR_CODE_123', {
                            width: 200,
                            height: 200,
                            margin: 2,
                            darkColor: '#000000',
                            lightColor: '#FFFFFF'
                        });
                        
                        if (success) {
                            console.log('‚úÖ Test QR code generated successfully with QR Code Manager');
                        } else {
                            throw new Error('QR Code Manager failed to generate test QR code');
                        }
                    } else {
                        // Fallback to direct QRCode library
                        console.log('üì± Using direct QRCode library for test...');
                        if (typeof QRCode === 'undefined') {
                            throw new Error('QRCode library not available');
                        }
                        
                        await new Promise((resolve, reject) => {
                            QRCode.toCanvas(testContainer, 'TEST_QR_CODE_123', {
                                width: 200,
                                height: 200,
                                margin: 2
                            }, (error) => {
                                if (error) {
                                    console.error('‚ùå Test QR generation failed:', error);
                                    reject(error);
                                } else {
                                    console.log('‚úÖ Test QR code generated successfully with direct library');
                                    resolve();
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Test QR code generation failed:', error);
                    this.showQRPlaceholder(testContainer);
                }
            }

            // Method untuk debug checkout data
            debugCheckoutData() {
                console.log('üîç === DEBUG CHECKOUT DATA ===');
                console.log('üì¶ Cart data:', this.cart);
                console.log('üõí Checkout data:', this.checkoutData);
                console.log('üí≥ Selected payment method:', this.selectedPaymentMethod);
                console.log('‚è≥ Is processing:', this.isProcessing);
                
                // Check localStorage
                const localStorageCart = localStorage.getItem('cart');
                const localStorageCheckout = localStorage.getItem('checkoutData');
                console.log('üíæ LocalStorage cart:', localStorageCart);
                console.log('üíæ LocalStorage checkout:', localStorageCheckout);
                
                // Parse and show parsed data
                try {
                    const parsedCart = JSON.parse(localStorageCart || 'null');
                    const parsedCheckout = JSON.parse(localStorageCheckout || 'null');
                    console.log('üìã Parsed cart:', parsedCart);
                    console.log('üìã Parsed checkout:', parsedCheckout);
                    
                    // Analyze item structure
                    if (parsedCheckout && parsedCheckout.items) {
                        console.log('üîç === ITEM STRUCTURE ANALYSIS ===');
                        parsedCheckout.items.forEach((item, index) => {
                            console.log(`üì¶ Item ${index + 1} structure:`, {
                                id: item.id,
                                productId: item.productId,
                                product_id: item.product_id,
                                name: item.name,
                                productName: item.productName,
                                product_name: item.product_name,
                                quantity: item.quantity,
                                qty: item.qty,
                                price: item.price,
                                finalPrice: item.finalPrice,
                                harga: item.harga,
                                totalPrice: item.totalPrice,
                                image: item.image,
                                imageUrl: item.imageUrl,
                                img: item.img,
                                specs: item.specs,
                                weight: item.weight,
                                purity: item.purity,
                                description: item.description
                            });
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error parsing localStorage data:', error);
                }
                
                // Show notification with summary
                const summary = `
                    Cart items: ${this.cart.length}
                    Checkout items: ${this.checkoutData.items?.length || 0}
                    Payment method: ${this.selectedPaymentMethod}
                    Processing: ${this.isProcessing}
                `;
                this.showNotification('Debug info logged to console', 'info');
            }

            // Method untuk load sample data
            loadSampleData() {
                console.log('üì¶ Loading sample checkout data...');
                
                const sampleData = {
                    items: [
                        {
                            id: 1,
                            name: 'Cincin Emas 24K',
                            price: 2500000,
                            finalPrice: 2500000,
                            quantity: 1,
                            weight: 5,
                            purity: '24K',
                            image: '/placeholder.svg',
                            specs: 'Berat: 5 gram | Kadar: 24K'
                        },
                        {
                            id: 2,
                            name: 'Kalung Emas 22K',
                            price: 1800000,
                            finalPrice: 1800000,
                            quantity: 2,
                            weight: 8,
                            purity: '22K',
                            image: '/placeholder.svg',
                            specs: 'Berat: 8 gram | Kadar: 22K'
                        }
                    ],
                    shipping: 0,
                    discount: 0
                };
                
                // Save to localStorage
                localStorage.setItem('checkoutData', JSON.stringify(sampleData));
                
                // Update checkout data
                this.checkoutData = sampleData;
                
                // Re-render
                this.renderOrderSummary();
                this.updateSummary();
                
                console.log('‚úÖ Sample data loaded:', sampleData);
                this.showNotification('Sample data loaded successfully!', 'success');
            }

            // Method untuk clear cart individual items
            async clearCartItem(itemId) {
                try {
                    console.log('üóëÔ∏è Clearing cart item:', itemId);

                    // Remove from localStorage cart
                    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const updatedCart = cart.filter(item => item.id !== itemId);
                    localStorage.setItem('cart', JSON.stringify(updatedCart));

                    // Try to remove from database
                    try {
                        const response = await fetch(`/user/cart/remove/${itemId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            console.log('‚úÖ Cart item removed from database');
                        } else {
                            console.warn('‚ö†Ô∏è Failed to remove cart item from database');
                        }
                    } catch (dbError) {
                        console.warn('‚ö†Ô∏è Database removal failed, but localStorage updated');
                    }

                    // Update local cart data
                    this.cart = updatedCart;
                    this.updateBadges();

                    console.log('‚úÖ Cart item cleared successfully');

                } catch (error) {
                    console.error('‚ùå Error clearing cart item:', error);
                }
            }

            // Method untuk mendapatkan current user ID
            async getCurrentUserId() {
                try {
                    const response = await fetch('/user/current');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            return result.data.id;
                        }
                    }
                } catch (error) {
                    console.error('Error getting current user:', error);
                }
                return null;
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Modal functions
        function openUpdateModal() {
            const modal = document.getElementById('updateModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('harga24k').focus();
        }

        function closeUpdateModal() {
            const modal = document.getElementById('updateModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('updateForm').reset();
        }

        // Global functions
        function fetchExternalPrice() {
            checkoutManager.fetchExternalPrice();
        }

        function refreshData() {
            checkoutManager.refreshData();
        }

        let checkoutManager;
        document.addEventListener('DOMContentLoaded', () => {
            checkoutManager = new CheckoutManager();
        });

        // Close modal when clicking outside (only if modal exists)
        const updateModal = document.getElementById('updateModal');
        if (updateModal) {
            updateModal.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeUpdateModal();
                }
            });
        }
    </script>
</body>

</html>