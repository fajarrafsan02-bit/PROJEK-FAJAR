<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kelola Pesanan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .order-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .order-card.pending-payment { border-left-color: #ffc107; }
        .order-card.pending-confirmation { border-left-color: #17a2b8; }
        .order-card.paid { border-left-color: #28a745; }
        .order-card.processing { border-left-color: #007bff; }
        .order-card.shipped { border-left-color: #6f42c1; }
        .order-card.delivered { border-left-color: #20c997; }
        .order-card.cancelled { border-left-color: #dc3545; }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .search-box {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        .search-box::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        .btn-action {
            margin: 0.1rem;
            min-width: 80px;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            min-width: 300px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-white shadow-sm py-3 mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0 text-primary">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Kelola Pesanan
                        </h2>
                        <p class="text-muted mb-0">Manajemen pesanan customer</p>
                    </div>
                    <div>
                        <a href="/admin/home" class="btn btn-secondary">
                            <i class="fas fa-home me-1"></i>
                            Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1" id="totalOrders">0</h3>
                            <p class="mb-0">Total Pesanan</p>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1" id="pendingPayment">0</h3>
                            <p class="mb-0">Menunggu Pembayaran</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1" id="pendingConfirmation">0</h3>
                            <p class="mb-0">Menunggu Konfirmasi</p>
                        </div>
                        <i class="fas fa-user-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1" id="paid">0</h3>
                            <p class="mb-0">Sudah Dibayar</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label">Filter Status:</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Semua Status</option>
                                    <option value="PENDING_PAYMENT">Menunggu Pembayaran</option>
                                    <option value="PENDING_CONFIRMATION">Menunggu Konfirmasi</option>
                                    <option value="PAID">Sudah Dibayar</option>
                                    <option value="PROCESSING">Diproses</option>
                                    <option value="SHIPPED">Dikirim</option>
                                    <option value="DELIVERED">Selesai</option>
                                    <option value="CANCELLED">Dibatalkan</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cari Pesanan:</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Cari nomor pesanan atau nama customer...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" id="searchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <button class="btn btn-success mb-2" id="exportBtn">
                            <i class="fas fa-download me-1"></i>
                            Export Excel
                        </button>
                        <br>
                        <button class="btn btn-info" id="refreshBtn">
                            <i class="fas fa-refresh me-1"></i>
                            Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Daftar Pesanan
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>No. Pesanan</th>
                                        <th>Customer</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Tanggal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 mb-0">Memuat data pesanan...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <nav aria-label="Orders pagination">
                            <ul class="pagination justify-content-center mb-0" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Detail Pesanan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Order Modal -->
    <div class="modal fade" id="confirmOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check me-2"></i>
                        Konfirmasi Pesanan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin mengkonfirmasi pesanan ini?</p>
                    <div class="mb-3">
                        <label for="confirmNotes" class="form-label">Catatan Admin (Opsional)</label>
                        <textarea class="form-control" id="confirmNotes" rows="3" placeholder="Masukkan catatan jika diperlukan..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" id="confirmOrderBtn">
                        <i class="fas fa-check me-1"></i>
                        Konfirmasi Pesanan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Update Status Pesanan
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Status Baru:</label>
                        <select class="form-select" id="newStatus">
                            <option value="PENDING_PAYMENT">Menunggu Pembayaran</option>
                            <option value="PENDING_CONFIRMATION">Menunggu Konfirmasi</option>
                            <option value="PAID">Sudah Dibayar</option>
                            <option value="PROCESSING">Diproses</option>
                            <option value="SHIPPED">Dikirim</option>
                            <option value="DELIVERED">Selesai</option>
                            <option value="CANCELLED">Dibatalkan</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Catatan (Opsional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" placeholder="Masukkan catatan perubahan status..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="updateStatusBtn">
                        <i class="fas fa-save me-1"></i>
                        Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        class OrderManager {
            constructor() {
                this.currentPage = 0;
                this.pageSize = 10;
                this.totalPages = 0;
                this.currentOrderId = null;
                this.orders = [];
                this.init();
            }

            init() {
                this.loadOrders();
                this.loadStatistics();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('statusFilter').addEventListener('change', () => this.loadOrders());
                document.getElementById('searchBtn').addEventListener('click', () => this.searchOrders());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchOrders();
                });
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadOrders());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportOrders());
                document.getElementById('confirmOrderBtn').addEventListener('click', () => this.confirmOrder());
                document.getElementById('updateStatusBtn').addEventListener('click', () => this.updateOrderStatus());
            }

            async loadOrders() {
                try {
                    const statusFilter = document.getElementById('statusFilter').value;
                    let url = `/admin/api/orders?page=${this.currentPage}&size=${this.pageSize}&sortBy=createdAt&sortDirection=desc`;
                    
                    if (statusFilter) {
                        url = `/admin/api/orders/status/${statusFilter}?page=${this.currentPage}&size=${this.pageSize}`;
                    }

                    const response = await axios.get(url);
                    
                    if (response.data.success) {
                        const data = response.data.data;
                        this.orders = data.content || data;
                        this.totalPages = data.totalPages || 1;
                        this.renderOrders();
                        this.renderPagination();
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    this.showToast('Gagal memuat data pesanan', 'error');
                }
            }

            async searchOrders() {
                try {
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    if (!searchTerm) {
                        this.loadOrders();
                        return;
                    }

                    // Try searching by order number first
                    let response = await axios.get(`/admin/api/orders/search/order-number?orderNumber=${searchTerm}`);
                    
                    if (response.data.success && response.data.data.length > 0) {
                        this.orders = response.data.data;
                    } else {
                        // Try searching by customer name/phone
                        response = await axios.get(`/admin/api/orders/search/customer?searchTerm=${searchTerm}`);
                        this.orders = response.data.success ? response.data.data : [];
                    }
                    
                    this.renderOrders();
                    this.renderPagination();
                } catch (error) {
                    console.error('Error searching orders:', error);
                    this.showToast('Gagal mencari pesanan', 'error');
                }
            }

            async loadStatistics() {
                try {
                    const response = await axios.get('/admin/api/orders/statistics');
                    if (response.data.success) {
                        const stats = response.data.data;
                        document.getElementById('totalOrders').textContent = stats.totalOrders;
                        document.getElementById('pendingPayment').textContent = stats.pendingPayment;
                        document.getElementById('pendingConfirmation').textContent = stats.pendingConfirmation;
                        document.getElementById('paid').textContent = stats.paid;
                    }
                } catch (error) {
                    console.error('Error loading statistics:', error);
                }
            }

            renderOrders() {
                const tbody = document.getElementById('ordersTableBody');
                
                if (this.orders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Tidak ada pesanan ditemukan</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.orders.map(order => `
                    <tr>
                        <td>
                            <strong>${order.orderNumber}</strong>
                        </td>
                        <td>
                            <div>
                                <strong>${order.customerName}</strong><br>
                                <small class="text-muted">${order.customerPhone}</small>
                            </div>
                        </td>
                        <td>
                            <strong>Rp ${this.formatCurrency(order.totalAmount)}</strong>
                        </td>
                        <td>
                            <span class="badge ${this.getStatusBadgeClass(order.status)}">
                                ${this.getStatusText(order.status)}
                            </span>
                        </td>
                        <td>
                            <small>${this.formatDateTime(order.createdAt)}</small>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm btn-action" onclick="orderManager.showOrderDetail(${order.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${order.status === 'PENDING_PAYMENT' || order.status === 'PENDING_CONFIRMATION' ? 
                                    `<button class="btn btn-outline-success btn-sm btn-action" onclick="orderManager.showConfirmModal(${order.id})">
                                        <i class="fas fa-check"></i>
                                    </button>` : ''
                                }
                                <button class="btn btn-outline-info btn-sm btn-action" onclick="orderManager.showUpdateStatusModal(${order.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${order.status === 'PENDING_PAYMENT' || order.status === 'PENDING_CONFIRMATION' ? 
                                    `<button class="btn btn-outline-danger btn-sm btn-action" onclick="orderManager.cancelOrder(${order.id})">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            renderPagination() {
                const pagination = document.getElementById('pagination');
                if (this.totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let paginationHTML = `
                    <li class="page-item ${this.currentPage === 0 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="orderManager.goToPage(${this.currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                `;

                for (let i = 0; i < this.totalPages; i++) {
                    if (i === this.currentPage || i === 0 || i === this.totalPages - 1 || 
                        (i >= this.currentPage - 1 && i <= this.currentPage + 1)) {
                        paginationHTML += `
                            <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="orderManager.goToPage(${i})">${i + 1}</a>
                            </li>
                        `;
                    } else if (i === this.currentPage - 2 || i === this.currentPage + 2) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }

                paginationHTML += `
                    <li class="page-item ${this.currentPage === this.totalPages - 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="orderManager.goToPage(${this.currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                `;

                pagination.innerHTML = paginationHTML;
            }

            goToPage(page) {
                if (page >= 0 && page < this.totalPages && page !== this.currentPage) {
                    this.currentPage = page;
                    this.loadOrders();
                }
            }

            async showOrderDetail(orderId) {
                try {
                    const response = await axios.get(`/admin/api/orders/${orderId}`);
                    if (response.data.success) {
                        const order = response.data.data;
                        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                        
                        document.getElementById('orderDetailContent').innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Informasi Pesanan</h6>
                                    <table class="table table-sm">
                                        <tr><td>No. Pesanan:</td><td><strong>${order.orderNumber}</strong></td></tr>
                                        <tr><td>Status:</td><td><span class="badge ${this.getStatusBadgeClass(order.status)}">${this.getStatusText(order.status)}</span></td></tr>
                                        <tr><td>Total:</td><td><strong>Rp ${this.formatCurrency(order.totalAmount)}</strong></td></tr>
                                        <tr><td>Tanggal:</td><td>${this.formatDateTime(order.createdAt)}</td></tr>
                                        ${order.paidAt ? `<tr><td>Tanggal Bayar:</td><td>${this.formatDateTime(order.paidAt)}</td></tr>` : ''}
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Informasi Customer</h6>
                                    <table class="table table-sm">
                                        <tr><td>Nama:</td><td>${order.customerName}</td></tr>
                                        <tr><td>Email:</td><td>${order.customerEmail}</td></tr>
                                        <tr><td>Telepon:</td><td>${order.customerPhone}</td></tr>
                                        <tr><td>Alamat:</td><td>${order.customerAddress || '-'}</td></tr>
                                    </table>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Item Pesanan</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Produk</th>
                                                    <th>Harga</th>
                                                    <th>Jumlah</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orderItemsTable">
                                                <tr><td colspan="4" class="text-center">Memuat item...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        modal.show();
                        this.loadOrderItems(orderId);
                    }
                } catch (error) {
                    console.error('Error loading order detail:', error);
                    this.showToast('Gagal memuat detail pesanan', 'error');
                }
            }

            async loadOrderItems(orderId) {
                try {
                    const response = await axios.get(`/admin/api/orders/${orderId}/items`);
                    if (response.data.success) {
                        const items = response.data.data;
                        const tbody = document.getElementById('orderItemsTable');
                        
                        if (items.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada item</td></tr>';
                            return;
                        }

                        tbody.innerHTML = items.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>Rp ${this.formatCurrency(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td>Rp ${this.formatCurrency(item.price * item.quantity)}</td>
                            </tr>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error loading order items:', error);
                    document.getElementById('orderItemsTable').innerHTML = 
                        '<tr><td colspan="4" class="text-center text-danger">Gagal memuat item</td></tr>';
                }
            }

            showConfirmModal(orderId) {
                this.currentOrderId = orderId;
                document.getElementById('confirmNotes').value = '';
                const modal = new bootstrap.Modal(document.getElementById('confirmOrderModal'));
                modal.show();
            }

            showUpdateStatusModal(orderId) {
                this.currentOrderId = orderId;
                document.getElementById('newStatus').value = 'PENDING_CONFIRMATION';
                document.getElementById('statusNotes').value = '';
                const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
                modal.show();
            }

            async confirmOrder() {
                if (!this.currentOrderId) return;
                
                try {
                    this.setLoading('confirmOrderBtn', true);
                    
                    const notes = document.getElementById('confirmNotes').value.trim();
                    const requestBody = notes ? { notes } : {};
                    
                    const response = await axios.post(`/admin/api/orders/${this.currentOrderId}/confirm`, requestBody);
                    
                    if (response.data.success) {
                        this.showToast('Pesanan berhasil dikonfirmasi', 'success');
                        this.loadOrders();
                        this.loadStatistics();
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmOrderModal'));
                        modal.hide();
                    } else {
                        this.showToast(response.data.message || 'Gagal mengkonfirmasi pesanan', 'error');
                    }
                } catch (error) {
                    console.error('Error confirming order:', error);
                    this.showToast('Gagal mengkonfirmasi pesanan', 'error');
                } finally {
                    this.setLoading('confirmOrderBtn', false);
                }
            }

            async updateOrderStatus() {
                if (!this.currentOrderId) return;
                
                try {
                    this.setLoading('updateStatusBtn', true);
                    
                    const status = document.getElementById('newStatus').value;
                    const notes = document.getElementById('statusNotes').value.trim();
                    
                    const requestBody = { status, notes };
                    
                    const response = await axios.put(`/admin/api/orders/${this.currentOrderId}/status`, requestBody);
                    
                    if (response.data.success) {
                        this.showToast('Status pesanan berhasil diupdate', 'success');
                        this.loadOrders();
                        this.loadStatistics();
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('updateStatusModal'));
                        modal.hide();
                    } else {
                        this.showToast(response.data.message || 'Gagal mengupdate status', 'error');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    this.showToast('Gagal mengupdate status pesanan', 'error');
                } finally {
                    this.setLoading('updateStatusBtn', false);
                }
            }

            async cancelOrder(orderId) {
                if (!confirm('Apakah Anda yakin ingin membatalkan pesanan ini?')) return;
                
                try {
                    const response = await axios.post(`/admin/api/orders/${orderId}/cancel`, {});
                    
                    if (response.data.success) {
                        this.showToast('Pesanan berhasil dibatalkan', 'success');
                        this.loadOrders();
                        this.loadStatistics();
                    } else {
                        this.showToast(response.data.message || 'Gagal membatalkan pesanan', 'error');
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    this.showToast('Gagal membatalkan pesanan', 'error');
                }
            }

            async exportOrders() {
                try {
                    const statusFilter = document.getElementById('statusFilter').value;
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    
                    let url = '/admin/api/orders/export?';
                    if (statusFilter) url += `status=${statusFilter}&`;
                    if (searchTerm) url += `search=${searchTerm}&`;
                    
                    const response = await axios.get(url, { responseType: 'blob' });
                    
                    const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = `orders-export-${new Date().toISOString().split('T')[0]}.xlsx`;
                    link.click();
                    
                    this.showToast('Data berhasil diexport', 'success');
                } catch (error) {
                    console.error('Error exporting orders:', error);
                    this.showToast('Gagal mengexport data', 'error');
                }
            }

            getStatusBadgeClass(status) {
                const statusClasses = {
                    'PENDING_PAYMENT': 'bg-warning',
                    'PENDING_CONFIRMATION': 'bg-info',
                    'PAID': 'bg-success',
                    'PROCESSING': 'bg-primary',
                    'SHIPPED': 'bg-secondary',
                    'DELIVERED': 'bg-success',
                    'CANCELLED': 'bg-danger'
                };
                return statusClasses[status] || 'bg-secondary';
            }

            getStatusText(status) {
                const statusTexts = {
                    'PENDING_PAYMENT': 'Menunggu Pembayaran',
                    'PENDING_CONFIRMATION': 'Menunggu Konfirmasi',
                    'PAID': 'Sudah Dibayar',
                    'PROCESSING': 'Diproses',
                    'SHIPPED': 'Dikirim',
                    'DELIVERED': 'Selesai',
                    'CANCELLED': 'Dibatalkan'
                };
                return statusTexts[status] || status;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID').format(amount);
            }

            formatDateTime(dateString) {
                return new Date(dateString).toLocaleString('id-ID');
            }

            setLoading(buttonId, loading) {
                const button = document.getElementById(buttonId);
                if (loading) {
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText || button.innerHTML.replace(/Loading\.\.\./, '');
                }
            }

            showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = 'toast-' + Date.now();
                
                const bgClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[type] || 'bg-info';

                const toastHTML = `
                    <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                        <div class="toast-header ${bgClass} text-white">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong class="me-auto">Notifikasi</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                `;

                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }
        }

        // Initialize the order manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.orderManager = new OrderManager();
        });
    </script>
</body>
</html>